#version 420 core

layout(location = 0) out vec4 color;

layout(binding = 0) uniform sampler2D texture;
layout(binding = 1) uniform sampler2D normalmap;
layout(binding = 2) uniform sampler2D specularmap;
layout(binding = 3) uniform sampler2D opacitymap;
uniform bool diffuse_enabled;
uniform bool normalmap_enabled;
uniform bool specularmap_enabled;
uniform bool opacitymap_enabled;

in vec2 uv;

smooth in vec3 fTangent;
smooth in vec3 fBinormal;
smooth in vec3 fNormal;

void main (void)
{
	vec3 diffuse;
	vec3 normal;
	vec3 specular;
	float opacity;
	
	if (diffuse_enabled)
		diffuse = texture2D (texture, uv).xyz;
	else
		diffuse = vec3 (1.0, 1.0, 1.0);

	if (specularmap_enabled)
		specular = texture2D (specularmap, uv).xyz;
	else
		specular = vec3 (0.0, 0.0, 0.0);

	if (opacitymap_enabled)
		opacity = texture2D (opacitymap, uv).x;
	else
		opacity = 0;

	if (normalmap_enabled)
	{
		vec3 n;
		mat3x3 tangentmat;
		tangentmat = mat3x3 (fTangent, fBinormal, fNormal);

		n.xy = texture2D (normalmap, uv).xy * 2.0 - 1.0;
		n.z = sqrt (1.0 - n.x * n.x - n.y * n.y);
		normal = (tangentmat * n) * 0.5 + 0.5;
	}
	else
	{
		normal = fNormal * 0.5 + 0.5;
	}

	color = vec4 (diffuse, opacity);

}
