#version 420 core
layout(binding = 0) uniform sampler2D depthbuffer;
layout(binding = 1) uniform sampler2D positionbuffer;

/*
 * projinfo.x = 1.0f / projmat[0].x;
 * projinfo.y = 1.0f / projmat[1].y;
 * projinfo.z = nearClipPlane;
 * projinfo.w = farClipPlane;
 */
uniform vec4 projinfo;
uniform mat4 mvmat;
uniform uvec2 viewport;

vec3 ReconstructPosition (void)
{
	vec4 pos;
	float near = 0.1;
	float far = 50.0;

	// reconstruct clip coordinates
	pos.xy = gl_FragCoord.xy / viewport;
	pos.z = texture2D (depthbuffer, pos.xy).r;
	pos.w = texture2D (positionbuffer, pos.xy).w;
	pos.xyz *= 2;
	pos.xyz -= 1;
	pos.xyz *= pos.w;

	// reconstruct eye coordinates
	vec4 p;
	p.x = pos.x * projinfo.x;
	p.y = pos.y * projinfo.y;
	p.z = -pos.w;
	p.w = (pos.z * (projinfo.z - projinfo.w)
	      + pos.w * (projinfo.z + projinfo.w))
	      / (2 * projinfo.z * projinfo.w);

	// reconstruct object coordinates
	pos = inverse (mvmat) * p;
	return pos.xyz;
}
