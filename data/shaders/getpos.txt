#version 420 core

/*
 * projinfo.x = 1.0f / projmat[0].x;
 * projinfo.y = 1.0f / projmat[1].y;
 * projinfo.z = nearClipPlane;
 * projinfo.w = farClipPlane;
 */
uniform vec4 projinfo;
uniform mat4 vmatinv;
layout(binding = 1) uniform samplerRect depthbuffer;
uniform uvec2 viewport;

/* reconstructs the object space coordinates
 * from depth and w information */
vec3 GetPos (void)
{
	vec4 pos;
	float near = 0.1;
	float far = 50.0;

	// reconstruct clip coordinates
	pos.xyz = vec3 (gl_FragCoord.xy / viewport,
		        texture (depthbuffer, gl_FragCoord.xy).r)
		  * 2 - 1;
	pos.w = 1;

	// reconstruct eye coordinates
	vec4 p;
	p.x = pos.x * projinfo.x;
	p.y = pos.y * projinfo.y;
	p.z = -pos.w;
	p.w = (pos.z * (projinfo.z - projinfo.w)
	      + pos.w * (projinfo.z + projinfo.w))
	      / (2 * projinfo.z * projinfo.w);

	// reconstruct object coordinates
	pos = vmatinv * p;
	if (abs (pos.w) < 0.0001)
	   discard;
	return pos.xyz / pos.w;
}
